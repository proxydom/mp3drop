# mp3drop üéß

**mp3drop** is a proof-of-concept Windows shellcode loader disguised as an audio file.
It demonstrates how arbitrary payloads can be embedded in seemingly harmless media and executed using low-level **NT API calls** (no `VirtualAlloc`).

This project is **educational only**, built to explore Windows internals, shellcode loading techniques, and red-team research.



## Features

* **NT API execution**: leverages `NtAllocateVirtualMemory` and `NtProtectVirtualMemory` directly.
* **Audio stego-style embedding**: shellcode is appended to an MP3 after a magic marker (`MAGIC1234`, can be changed in the code).
* **Minimal loader**: compact C program, cross-compiled with MinGW-w64.
* **Debug mode**: loader shows payload length and first bytes before jumping.
* **No external dependencies** (besides MinGW for compilation).

## üî¨ How and why it works?

Media formats like **MP3** are permissive: most decoders will happily play a file even if extra bytes are appended at the end. This ‚Äúslack space‚Äù can be abused to hide arbitrary data (in this case, **raw shellcode**) after a recognizable marker string (`MAGIC1234`). The player ignores it, but a custom loader can find it.

The loader process is simple but effective:

1. **Locate marker** ‚Üí scan the MP3 for `MAGIC1234`. Everything after it is treated as payload.  
2. **Extract payload** ‚Üí the raw shellcode bytes are copied into memory.  
3. **Allocate memory with NT API** ‚Üí instead of using high-level Win32 APIs (`VirtualAlloc`), the loader calls `NtAllocateVirtualMemory` directly from `ntdll.dll`. This is closer to how Windows internally manages memory and can bypass some user-mode hooks set by EDR/AV.  
4. **Change protections** ‚Üí memory is flipped from `PAGE_READWRITE` to `PAGE_EXECUTE_READWRITE` using `NtProtectVirtualMemory`, so instructions can run.  
5. **Execute in-process** ‚Üí the loader jumps straight into the allocated region, transferring execution to the shellcode.

### Why it matters
- **Stego-style embedding** ‚Üí data looks like a normal MP3 to casual inspection.  
- **NT API usage** ‚Üí avoids the more obvious Win32 wrappers that security products often monitor.  
- **In-memory execution** ‚Üí the payload is never dropped as an executable on disk; it lives only inside the host process‚Äôs memory.  
- **Minimal footprint** ‚Üí the loader is compact, with no runtime libraries or external dependencies, reducing behavioral noise.  


## Usage

### 1. Generate shellcode

```bash
msfvenom -p windows/x64/exec CMD=calc.exe -f raw -o shellcode.bin
```
### 2. Embed into MP3

```bash
python3 builder.py song.mp3 shellcode.bin
```

Output ‚Üí `song_with_shellcode.mp3`

### 3. Compile loader

```bash
x86_64-w64-mingw32-gcc PoC.c -o mp3drop.exe -lkernel32 -lntdll
```

### 4. Run on Windows

Place `song_with_shellcode.mp3` and `mp3drop.exe` together.
Execution flow:

1. Loader finds marker (`MAGIC1234`) inside MP3
2. Extracts appended shellcode
3. Allocates memory via NT API
4. Executes payload

Result ‚Üí `calc.exe` (or whatever shellcode you have) launches.

### A limitation:
It‚Äôs important to note that `mp3drop` expects **raw shellcode** (Position Independent Code), not a full `.exe`.

A Windows executable (PE file) relies on the **PE loader** to fix imports, relocations, and initialize runtime state before `main()` runs. If you simply append an `.exe` file, the loader in this PoC won‚Äôt know how to handle it, it will just copy opaque bytes into memory and crash when trying to execute them.

To work correctly, the payload must be either:
- **Shellcode generated by tools** (e.g., `msfvenom -f raw`) that is already position-independent and self-contained.  
- **Custom Position Independent Code (PIC)** you write yourself (in C or assembly), where you manually resolve the APIs you need at runtime.

This is why small PoC shellcode (like `exec calc.exe`) works fine, while a full compiled `.exe` does not: the PoC loader does not implement a PE loader, only a ‚Äúcopy-and-jump‚Äù mechanism for raw shellcode.

## ‚ö†Ô∏è Disclaimer

This project is provided **strictly for research and educational purposes**.
Do **NOT** use it on systems you don‚Äôt own or have explicit permission to test.
I'm not responsible for misuse.

## Credits

* Inspired by Windows internals & red-team research
* Loader design based on NT API syscall exploration
* Tested with MinGW-w64 on Linux + Windows 10/11

## Future Work

* Optional AES-CTR encryption for embedded shellcode
* Other file formats like .avi, .mp4, .wav and so on
